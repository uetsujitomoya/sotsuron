本章では，本研究で提案するビジュアル分析システムで用いる計算，技術について述べる．


\section{入力データの前処理}


まず本論文の実験で用いる対象データについて述べる．後述する全ての実験において、対象データは共通して以下のデータを使用した。

本論文の実験で用いる対象データには「心療内科における摂食障害専門ヨーガ療法グループ」の「ヨーガ療法事例検討会」資料\cite{txt1}\cite{txt2}\cite{txt3}\cite{txt4}\cite{txt5}を使用した．

後述する提案システムに読み込ませるための前処理として、まず，各カウンセリング回ごとにテキストデータを分けた。


\begin{itemize}
\item 2014年9月11日\cite{txt1}
\item 2014年11月19日\cite{txt2}
\item 2014年1月29日\cite{txt3}
\item X年8月10日\cite{txt4}
\item X年10月1日\cite{txt4}
\item X年10月30日\cite{txt5}
\end{itemize}
2014年9月11日については患者A,Bの2名がいたので、この日のデータについてはさらに患者ごとにテキストデータを分けた。またこの患者Aは2014年1月29日の患者と同一人物、患者Bは2014年11月19日の患者と同一人物である。以降、本論文においてもこの2名の患者を順に患者A,Bと呼ぶ。

一方、X年8月10日、X年10月1日、X年10月30日では同一の一名の患者が対象とされていた。対象データ内では「患者A」と呼ばれているが、前述の患者Aとは同一人物ではないため、以降、本論文中においては患者Cと呼ぶことにする。

ここで2014年9月11日、2014年11月19日、2014年1月29日においてはヨーガの瞑想前とヨーガの瞑想後のテキストデータが存在したので、瞑想前後で分けたテキストデータも用意した。つまり
\begin{itemize}
\item 2014年9月11日患者A
\item 2014年9月11日患者A瞑想前
\item 2014年9月11日患者A瞑想後
\item 2014年9月11日患者B
\item 2014年9月11日患者B瞑想前
\item 2014年9月11日患者B瞑想後
\item 2014年11月19日患者B
\item 2014年11月19日患者B瞑想前
\item 2014年11月19日患者B瞑想後
\item 2014年1月29日患者A
\item 2014年1月29日患者A瞑想前
\item 2014年1月29日患者A瞑想後
\item X年8月10日患者C
\item X年10月1日患者C
\item X年10月30日患者C
\end{itemize}
の計15個のテキストデータを用意した。

さらに、この提案システムの有用性を示すために模擬データを1個用意した。

以上、16個のカウンセリングの文字起こしテキストデータをそれぞれjsonファイルに変換した。[\{"a":"(本文)"\}]の形式で作成した．

\section{提案システムのプロトタイプ開発}



　
次に、前セクションで前処理した後のjsonデータを、提案システムがどう処理するかを説明する。提案システムのスクリーンショットを図\ref{fig:systemtsukaikata}に示す。
 \begin{figure}
   \begin{center}
     \includegraphics[width=10cm]{systemtsukaikata.png}
   \end{center}
   \caption{提案システムのスクリーンショット}
   \label{fig:systemtsukaikata}
 \end{figure}

まず、ブラウザ上で各テキストのjsonファイルを読み込んで形態素解析する．
形態素解析には，JavaScript言語の形態素解析ライブラリであるkutomoji.jsを使用した．
カウンセリング文字起こしテキストデータを形態素解析し，共起マップなどを描画して「家族」「仕事」「友人」に関連する単語を探す．そこから，カウンセラーからの質問形態と， 「家族」「仕事」「友人」の単語グループの時間経過に沿った分布変化を可視化した．
　
本システムでは、患者ないしカウンセラーの一発言を、話者の交代によって判断するものとする。つまり、患者の一発言は、カウンセラーが喋り終わって患者が喋り始めてから、患者が喋り終わってカウンセラーが喋り始めるまでである。また、カウンセラーの一発言は、患者が喋り終わってから、あるいはカウンセラーが話を切り出し始めてから、カウンセラーが喋り終わって患者が喋り始めるまでである。

jsonファイル内の本文の形式について説明する．全角表示のコロン（：）で話者の交代を認識，全角表示のコロン（：），全角表示の句点（．）ないしクエスチョンマーク（？,?）で文の終わりを認識するよう設定されている．そのため，話者が交代するたびに全角表示のコロン（：）で区切れ目を示さないといけない．

\subsubsection{積み重ね折れ線グラフ}
Fig.2において，まず積み重ね折れ線グラフは患者の1回1回の発言の中での，アドラー心理学の各カテゴリの分布を可視化している．ただし1回1回の発言は，話者の交代を発言の区切れ目とする．この積み重ね折れ線グラフにおいて青色は「仕事関係」，ピンク色は「愛（恋愛・家族関係）」，緑色は「交友（友人関係）」に密接に関係する単語を含む文の分布を表している．
　横軸は時間軸を表現している。ただし対象データである書き起こしテキストデータからは実際の経過秒数は読み取れないので、読み込ませたデータ内における患者の発言量の合計に対して

\subsubsection{カウンセラーの質問を表現する縦棒}

Ericら\cite{taskdriven}は、トピックモデリングによって分けたトピックの時間分布を上下の非対称積み重ね折れ線グラフによって可視化した。一方本研究では、カウンセラーとクライエントの会話において、クライエントは文ごとに、カウンセラーは発言ごとに描画を行いたい、かつ選択肢表示のためにグラフを省スペースしたいという観点から、カウンセラーの発言を横軸より下に折れ線グラフとして描画するのではなく、患者の発言のグループ分布を示す積み重ね折れ線グラフに重ねて縦棒として表示するようにした。


積み重ね折れ線グラフに重なっている，紫色ないし濃いグレー色の縦棒は，カウンセラーの質問内容の形態を示す．紫色は5W1H「いつ」「どこで」「誰が」「何を」「どのように」「どうした」などで問われるような「開かれた質問」，濃いグレー色はYes/Noで答えられる，あるいは一言だけで簡単答えられるような「閉じられた質問」を表現している．第1章で述べた通り，患者が何に問題意識を感じているかをカウンセリングで引き出すには，カウンセラーは「閉じられた質問」よりも「開かれた質問」をしたほうがよいとされている．
%　このシステムにおいて、

%\subsection{結果}

　
模擬データでの可視化結果を図\ref{fig:system1mogi2}，2014年11月検討会 患者A瞑想後での可視化結果を図\ref{fig:system1a0911go}，2015年11月検討会 患者Cのデータでの可視化結果を図\ref{fig:system1_1002}に示す．
 \begin{figure}
   \begin{center}
     \includegraphics[width=10cm]{system1mogi2.png}
   \end{center}
   \caption{提案システム１の模擬データでの可視化結果}
   \label{fig:system1mogi2}
 \end{figure}
 \begin{figure}
   \begin{center}
     \includegraphics[width=10cm]{system1a0911go.png}
   \end{center}
   \caption{提案システム１の'14年11月検討会A瞑想後での可視化結果}
   \label{fig:system1a0911go}
 \end{figure}
 \begin{figure}
   \begin{center}
     \includegraphics[width=10cm]{system1_1002.png}
   \end{center}
   \caption{提案システム１の'15年11月検討会Cでの可視化結果}
   \label{fig:system1_1002}
 \end{figure}




　

　
　

%\subsection{考察}
%クライエントからの返答だけでなく、カウンセラーの質問区分けもラジオボタンによって手動で行えるように修正したい．また、どの時間軸座標がどの発言を指し示すか明記しないと考察しがたいので，マウスオーバーによって発言内容が表示される仕組みを作りたい。

%原文から，セラピストから患者への質問事項の分類の指標として，患者の発言をうながして患者自身も気づいていなかったことを認知させるのが大事であるので，それぞれの発言量の可視化の実装を盛り込むべきであると考えられる．





%\subsubsection{どこがどの発言を表しているかわからない}



%\subsubsection{インタラクティブ性がない}
%描画後にラジオボタンを変えても反応がない。現状ではその場でチェックボックスの選択を変えただけではグラフにその選択の変更が反映されず，1回1回ブラウザ上でページをリロードして，カウンセリングの文字起こしテキストデータのjsonファイルも読み込み直す必要が生じている．ブラウザ上でページをリロードしなくも，チェックボックスの選択を変えることでシームレスにグラフが変化することが求められた．

%\subsubsection{「その他」}
%「開かれた質問」「閉じられた質問」だけでなく、相づちや世間話を「その他」を設けるべきと考えられる。提案システム1においては、「なぜ」「何」などの5W1Hを訊くような疑問視を含む発言を「開かれた質問」として定義し、それ以外を「閉じられた質問」と定義していたので、提案システム1における「閉じられた質問」をさらに、以降のシステムにおいて「閉じられた質問」と「その他」にわける必要があると考えられる。


%\subsubsection{ラジオボタン表示時間}

%カウンセリングの文字起こしテキストデータのjsonファイルの読み込み開始から選択肢の表示までに約10秒かかるので、この短縮が求められる．





%\section{提案システム２}


%提案システム2で専門家からされた指摘を元に修正および改善を行い、提案システム3を作成した。




%ここでは主に，提案システム2が抱えていた問題への対処について述べる．

%\subsubsection{どこがどの発言を表しているかわからない}
%提案システム１では、どの時間軸座標がどの発言を指し示すか明記していなかった。その問題を解決するために、提案システム２においては、マウスオーバーによって発言内容が表示される仕組みを作った．カウンセラーからの質問の区分けを示す各縦棒について，それぞれその上をマウスオーバーするたびに，積み重ね折れ線グラフを描画するSVG領域のすぐ上に，各々その縦棒が指し示すカウンセラーからの質問に対応する発言，および，そのカウンセラーの発言から，患者の発言とカウンセラーの発言を含めてそれぞれ前後3発言ずつを描画するようにプログラムした．つまり，患者の発言が前後2発言ずつ，カウンセラーの発言が3発言表示されているようにした．

%\subsubsection{インタラクティブ性}
%また，提案システム1においてはインタラクティブ性がなかった．各単語を患者の話題の分野ごとにわけるチェックボックスについて，提案システム1ではその場でチェックボックスの選択を変えただけではグラフにその選択の変更が反映されず，１回１回ブラウザ上でページをリロードして，カウンセリングの文字起こしテキストデータのjsonファイルも読み込み直す必要が生じていた．

%しかし提案システム2では，ブラウザ上でページをリロードしなくも，チェックボックスの選択を変えることでシームレスにグラフが変化するように改善した．また，患者の話題の分野を各単語ごとに決め打ちしたものだけでなく，決め打ちしていないものに関しても選択肢を表示し選択できるようにした．


%\subsubsection{「開かれた質問」・「閉じられた質問」・「その他」}
%さらに提案システムでは，カウンセラーからの各質問においても，5W1H「いつ」「どこで」「誰が」「何を」「どのように」「どうした」などで問われるような「開かれた質問」なのか，Yes/Noで答えられる，あるいは一言だけで簡単答えられるような「閉じられた質問」なのか，あるいは無駄話・相づちなど，どちらにも分類されないような「その他」なのかを，ユーザーが手動で修正できるようにした．

%カウンセラーからの各質問において，それぞれ「開かれた質問」・「閉じられた質問」・「その他」の選択肢が表示され，提案システム1で予測された選択肢にあらかじめチェックが入っているようプログラムした．そして，各単語を患者の話題の分野ごとにわけるチェックボックスと同様に，ブラウザ上でページをリロードしなくも，チェックボックスの選択を変えることでシームレスにグラフが変化するようにした．


%\subsubsection{「その他」}
%「開かれた質問」「閉じられた質問」だけでなく、相づちや世間話などを含む「その他」を設けるべきと指摘されたので、提案システム１の仕組みにおいて「開かれた質問」と判定されなかったカウンセラーの発言のうち、終助詞「か」を含むものを「閉じられた質問」とし、それ以外を「その他」とした。

%また、積み重ね折れ線グラフ上において、「閉じられた質問」を濃いグレー色の縦棒で、「その他」を薄いグレー色の縦棒で描画した。


%\subsubsection{ラジオボタン表示時間}

%提案システム1においてカウンセリング文字起こしテキストデータのjsonファイルの読み込み開始から選択肢の表示までに約10秒かかっていたのを，提案システム2においては必要時間約4秒にまで抑えた．




%\subsection{結果}

%　模擬データでの可視化結果を図\ref{fig:2_mogi}，X年8月患者Cデータでの可視化結果を図\ref{fig:2_0801}に示す．
% \begin{figure}
%   \begin{center}
%     \includegraphics[width=10cm]{2_mogi.png}
%   \end{center}
%   \caption{提案システム２の模擬データでの可視化結果}
%   \label{fig:2_mogi}
% \end{figure}
% \begin{figure}
%   \begin{center}
%     \includegraphics[width=10cm]{2_0801.png}
%   \end{center}
%   \caption{提案システム２のX年8月患者Cデータでの可視化結果}
%   \label{fig:2_0801}
% \end{figure}
%
%　「愛」「仕事」などの分類に選択する単語について，品詞レベル（動詞・形容詞・名詞など）で分類することは不可能だと考えられる．たとえば，「仕事」という単語が出てきても，愛の課題としての夫についてのはなしをしているときは，そのシチュエーションでは愛の課題になる．動詞，形容詞も同じく，どの課題のシチュエーションの中で使用されているかによってどの分類かが決定されるので，この分類方法は不適当と考えられる．
%　よって，話題がこの３つの課題のどれに入っているか，という分類でしかできないと考えられる．つまり，１文がどの課題に入っているか，という分類が適当だと考えられる．
%　たとえば，「うちの夫は仕事にいくのを嫌がって，毎朝起きてこないんです．それを見ているだけで腹が立つんです．自分の同僚が同じように仕事に行きたがらなくて朝起きなかったという話を聞いても，さほど腹は立ちませんが，夫がそうなるのは絶対に許せない！！」というような文章については，最初の文は愛のタスク，　第２文は仕事のタスク，第３文は愛のタスクととらえられる．


%　その他，使用した際に不便だと感じたこと，もし実用的なものにするにはどういう機能がついていればいいか等，意見をいただいた．

%　発話量の折れ線グラフの色分けについては，その人の関心が向いている話題によって分けられるので，分類方法の工夫が必要だと考えられる．
%　また実際には，話している中で関心がどんどん飛んでいく人が多いため，どうしていくか
%　いずれにしても，セラピストの発話については，十分とらえられると思います．質問形式（開かれた，閉じられた）と解釈と，相槌・その他と無駄話に分ける．無駄話と相槌は同レベルではなく，カウンセリングに必要かどうかの重みが違うので，分けた方がよいと考えられる．
%　セラピストのスーパーヴィジョンとして使用していく方が，今は妥当だと考えられる．そのためには，セラピストの発話内容を正確に分類していく方が的確に可視化できると考えられる．
%　心理臨床におけるスーパーヴィジョンにおいて，客観性にもとづく指導が可能になることが求められる。
%　一部のjsonファイルについて、質問形式の設定において，セラピストとクライエントの会話が混在しており，クライエントの会話については設定ができなかった．ここでクライエントの会話文を質問形式と無駄話にわける意味はないので，会話形式については，セラピストの発話だけわけるべきである．
%　また，このような混在があったときに，ユーザー側で削除できるようになるとスピーディーに修正が可能と考えられる．

%\subsection{課題}

%　患者の発言について
%単語単位ではなく文単位で「愛」「交友」「仕事」を分類すべき
%セラピストの発言について
%「開かれた質問」「閉じられた質問」だけでなく、「解釈」「相づち」「無駄話」も分類すべき
%選択肢が多すぎる
%分量に応じて縦棒の太さや間隔を変えることを提案





%　セラピストの質問を表す縦軸の太さや間隔をセラピストや患者の発言数に応じて変更されたデザインを提案した。




%\section{提案システム３}


%　提案システム2でカウンセラーからされた指摘を元に、提案システム3を作成した。






%ここでは主に，提案システム2が抱えていた問題への対処について述べる．

　
%\subsubsection{「解釈」・「相づち」・「無駄話」}
%提案システム2において、患者の発言について単語単位ではなく文単位で「愛」「交友」「仕事」を分類していた。
%そこからさらに、提案システム3においては、カウンセラーの発言について「開かれた質問」「閉じられた質問」だけでなく，「その他」を設け，さらに「その他」を「解釈」「相づち」「無駄話」の3つに分類した．





%\subsubsection{その他の改善点}
%\begin{itemize}
% \item 患者の発言について、単語単位ではなく文単位で「愛」「交友」「仕事」を分類するようにした。
% \item そもそも選択肢を減らすべきだったという問題に対しては，複数の可能性があるものについてのみ選択肢を表示することで改善を図った．
% \item カウンセラーの１発言の分量に応じて縦棒の太さを、クライエントの１発言の分量に応じてカウンセラーの発言を表現する縦棒同士の間隔を変えた。こうすることによって、どの質問のあとに患者がたくさんの会話量を発したかがわかるようになった．
% \item 見やすさの観点から、ラジオボタンによって発言の分類を選択する部分と、縦棒をマウスオーバーした際に実際の文が表示される部分を、積み重ね折れ線グラフの下側に、横に並べて表示するようにした。
%\end{itemize}



%\subsection{結果}

%提案システム3をカウンセラー1名に使っていただき、以下のコメントをいただいた。
%\begin{itemize}
% \item 「質問形式が解釈、無駄話 の２種類しかないため、適切な分類ができませんでした。
 
%閉じられた質問は、本来セラピスト側の解釈を確認するための質問です。しか
%し、質問形としては開かれた質問と対をなしていますので、これはこれでおいて
%おき、質問形式ではない解釈を「解釈」に分類するのが妥当と考えます。よって、
%分類は、「開かれた質問」「閉じられた質問」「解釈」「相づち」「世間話」に
%分けていただくといいですね。」
%\end{itemize}
　

%\subsection{課題}



\section{カウンセラーからのフィードバックおよび要件抽出}

%　発話量の折れ線グラフの色分けについては，その人の関心が向いている話題によって分けられるので，分類方法の工夫が必要だと考えられる．
%　また実際には，話している中で関心がどんどん飛んでいく人が多いため，どうしていくか
%　いずれにしても，セラピストの発話については，十分とらえられると思います．質問形式（開かれた，閉じられた）と解釈と，相槌・その他と無駄話に分ける．無駄話と相槌は同レベルではなく，カウンセリングに必要かどうかの重みが違うので，分けた方がよいと考えられる．


%\subsection{全ての選択肢を順番に表示}
%選択肢をすべて表示してほしい
%クライエントの発言に関するラジオボタンとカウンセラーの発言に関するラジオボタンをわけて表示していたが、これを実際の会話順に直して表示してほしいというレビューをいただいた。


%\subsection{フォントサイズの向上}
%フォントサイズ最小の部分が多くお年をめした方には読めないというレビューをいただいた1文1文を折りたたむことでフォントサイズ向上させる

%\subsection{色彩の改善}
%フォントサイズ最小の部分が多くお年をめした方には読めないというレビューをいただいた1文1文を折りたたむことでフォントサイズ向上させる

%\subsection{配置}


%\subsection{文の区切れ目}
%例えば「ほんとに、朝も昼も見張られてないっていったら変な言い方ですけど、食べた
%いときに食べれる状況っていうのがすごく久しぶりで、なんか自分でもどうなん
%かなっていうのがあったんですけど、意外と普通にできたみたいな（笑）それは
%、ありますね・・・なんか家族がいたら食べなきゃいけなかったりとかするし」という文に対して、「・・・」より前の部分は「家族」「交友」「仕事」のどの分類にも属さず、「・・・」より後の部分は「家族」に属するが、プロトタイプバージョンにおいては「・・・」を「。」のような1文1文の区切れ目に設定してないので、区別した判定変更が提案システムユーザー側でできない。

%「・・・」を



2016年1月の「心の可視化研究会」にて、12名の専門家に本システムを見ていただき、以下のコメントをいただいた。

\begin{itemize}
\item クライエントからの返答だけでなく、カウンセラーの質問区分けも手動で修正したい．
\item 原文から，セラピストから患者への質問事項の分類の指標として，患者の発言をうながして患者自身も気づいていなかったことを認知させるのが大事であるので，それぞれの発言量の可視化の実装を盛り込むべきであると考えられる．
\item インタラクティブ性がない．現状ではその場でチェックボックスの選択を変えただけではグラフにその選択の変更が反映されず，1回1回ブラウザ上でページをリロードして，カウンセリングの文字起こしテキストデータのjsonファイルも読み込み直す必要が生じている．ブラウザ上でページをリロードしなくも，チェックボックスの選択を変えることでシームレスにグラフが変化してほしい．
\end{itemize}


\subsection{縦棒をマウスオーバーすることで周辺の発言を表示}




\begin{itemize}
\item どこがどの発言を表しているかわからない
\item ラジオボタンが多すぎてグラフが下の方にいく
\end{itemize}
という問題に対しては、カウンセラーから患者への質問を示す縦棒をマウスオーバーすることによって、周辺の発言を表示する機能を追加することで解決を図った。
　　　ラジオボタンとまとめて、グラフより下側に
　　　文章表示されるようにレイアウト変更


\subsection{インタラクティブ性}
インタラクティブ性がない、積み重ね折れ線グラフが描画された後にラジオボタンを変えてもインタラクティブに積み重ね折れ線グラフが変更されないという問題に対して、描画後にラジオボタンを変えると即時にグラフ描画に変更適用されるように改良を行った。

\subsection{ラジオボタン表示までの必要時間}
ローカルでの動作において、ラジオボタン表示に約10秒必要であり、その経過時間が問題視されていた。それを受け、今回はプログラム上の無駄な記述を省くことで約5秒に短縮した。

\subsection{クライエントの発言の分類単位}
患者の発言について単語単位ではなく文単位で「愛」「交友」「仕事」を分類するように変更した。

\subsection{カウンセラーの発言の分類単位}
カウンセラーの発言について、「開かれた質問」「閉じられた質問」だけでなく、「解釈」「相づち」「世間話」という分類を追加してほしいというレビューをいただいたので、追加を行った。

ここで、積み重ね折れ線グラフの初期描画の際の分類行程について説明する。この行程について簡単に説明した図を、図5.1に示す。まず「いつ」「どこ」「何」などのいわゆる5W1Hを示す疑問詞をもつ発言を「開かれた質問」に分類する。次に残りの発言のうち、単語数が５個以下のものを「相づち」に分類する。さらに残りの発言のうち終助詞「か」を含む発言を「閉じられた質問」に分類する。今までの３つに分類されなかったものは「解釈」か「世間話」に分類されるわけだが、終助詞の「ね」を含むものを「解釈」、含まないものを「世間話」とした。

\subsection{分量に応じた縦棒の太さや間隔}

分量に応じて縦棒の太さや間隔を変えることを提案した。


\subsection{文字色の改善}
文字色の改善が求められていたが、文字色黒い文字を色のついた墨つきかっこ【】で囲うようにした。

\subsection{軸の表示}
積み重ね折れ線グラフにおいて、軸を表示するようにした。

文字が小さい→変更

\subsection{軸の表示}
プロトタイプでは、患者の発言に関する選択肢がすべて表示された後にカウンセラーに関する発言が表示されるようになっていた。しかしそれではわかりづらいというレビューをもとに、元のテキストデータ通りの順番に並ぶように変更した。